---
title: "Introduction aux outils de la science reproductible"
author: Marie-Pierre Etienne
institute: "https://github.com/MarieEtienne/reproductibilite"
date: "Septembre 2022"
csl: "../resources/apa-no-doi-no-issue.csl"
output:
   xaringan::moon_reader:
    css: [  'metropolis',  '../courses_tools/resources/mpe_pres.css']
    lib_dir: libs
    nature:
      ratio: 16:10
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: '../courses_tools/resources/collapseoutput.js'
    includes:
      after_body: '../courses_tools/resources/insert-logo.html'
---



```{r setup, include = FALSE,  eval = TRUE}
main_dir <-  '..'
common_img_dir <- file.path(main_dir,'courses_tools','resources', 'common_figs')
course_img_dir <- file.path(main_dir,'resources', 'figs')
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "alphabetic",
           style = "markdown",
           hyperlink = FALSE,
           dashed = FALSE)
myBib <- ReadBib('bibliography.bib', check = FALSE)
with_sol <- TRUE ## in order to control the output
with_course <- TRUE
```



name: motiv
# Motivations

---
template: motiv

## La recherche reproductible


 Dans leur [papier](../resources/bes2.1801.pdf) `r Citet(myBib,'alston2021beginner')` font le point sur la question de la recherche reproductible en écologie.
 
 
 Ils identifient des  [Points clé](../resources/bes2.1801_crop.pdf)


Les journaux scientifiques exigent de plus en plus de reproductibilité.

--

## En pratique

Une [vidéo](https://youtu.be/s3JldKoA0zw) de  [Ignasi Bartomeus](https://bartomeuslab.com/)  vaut mieux qu'un long discours 


--

## Objectif de ce cours 

Initier aux outils pour faciliter l'étape 2.


---

# Vue d'ensemble et panorama d'outils

## Le code 

- .care[git] pour

- garder des traces des différentes versions du code
- pour travailler à plusieurs
- pour relire/amender le code des autres

--


## Autour du code 

- .care[[Rmarkdown](https://rmarkdown.rstudio.com/)] associe  du code R et du texte pour

  * des exemples d'utilisations, 
  * les fichiers d'aide de R, 
  * des articles, 
  * des dashboards ....
  
- Les [Jupyter notebooks](https://jupyter.org/)  permettent la même chose pour différents languages (Python, R, Julia, ...) 

 [Computo](https://computo.sfds.asso.fr/) réclame des contributions sous forme de Jupyter notebook ou Rmarkdown


--

## Figer/Gerer les versions de logiciel utilisés 

Pour assurer la reproductibilité, il ne suffit pas de s'assurer que le code a tourné une fois sur une machine avec succès.  


Le systeme de container [Docker](https://www.docker.com/) permet de figer un environnement sur lequel le programme fonctionne.

---

# Le trio gagnant de la recherche reproduction avec R

- .care[git]
- .care[Rmarkdown]
- Docker


---
name: gitintro
# Introduction à git

---
template: gitintro

## Qu'est ce que git ?

Linus Torvalds: *I'm an egotistical bastard, and I name all my projects after myself. First Linux, now [git](https://www.wordreference.com/enfr/git).*

--

Git est un système de contrôle de version (le plus largement utilisé aujourd'hui). Il permet de suivre l'ensemble des modifications apportées à un code depuis sa création.

Git est très performant.

Git est un peu sauvage, pas simple  à maîtriser.



---
template: gitintro

## Graphiquement, sous forme d'arbre

<img src="../resources/figs/git1.svg" width="900" height = "300" alt = "simple branche"></img>


Cf example git_example avec la commande

```{r git_illustration, eval = FALSE}
git log
```



---
template: gitintro

## Utiliser git : configuration

Le but de git est de garder une trace des différentes versions d'un projet et de leur auteur, il faut donc s'identifier. Dans une console git taper la commande :

```{r git_config, eval = FALSE}
git config --global user.email "votre adresse mail"
git config --global user.name "votre nom"`
git config -l # pour vérifier
```

---
template: gitintro

## Utiliser git : cloner un repo distant


* Cloner le dépot qui va nous servir d'example, dans une console git taper la commande :

```{r git_clone, eval = FALSE}
cd # pour se placer dans son repertoire pricipal
ls   #commande qui liste le contenu d'un répertoire
git clone  nomdudepot # commande qui clone effectivement le repot distant
ls # on regarde ce qui est maintenant dans le repo
```

--

* Taper la commande `git log`

* ou un peu plus visuel, `gitk`

---
template: gitintro

## Utiliser git : contribuer au code

* Ouvrir le fichier `manchots.Rmd` et ajouter votre nom et la liste des auteurs et sauvegarder votre fichier . 
--

* Taper la commande `git log` dans la console
--

* Taper la suite de commandes :

```{r status_diff, eval = FALSE}
git status # etat de notre projet
git diff
```

--

* Taper la commande `git add manchots.Rmd`  puis refaire les commandes précédentes

--


* Taper la commande `git commit -m "Ajout d'un auteur"` et à nouveau les commandes pour connaitre l'état du projet.

--

* Dessiner l'arbre des commits

--

<img src="../resources/figs/git2.svg" width="800" height = "250" alt = "simple branche"></img>



---
template: gitintro

## Utiliser git : vision du processus

<img src="../resources/figs/Vision_globale_git_step1.png" width="800" height = "300" alt = "bilan1"></img>

--

### Analogie avec une photo (snapshot)

- Dans le répertoire de travail, on essaie des poses (Working directory)

- Quand est satisfait de la position d'un objet, on lui demande de rester ainsi (Staging area)

- Quand on est satisfait de la position de tous les objets, on prend la photo (local repos)


---
template: gitintro

## Utiliser git : Travailler à plusieurs


La version actuelle du projet est donc bien enregistrée dans le système de suivi, mais nous sommes les seuls à le savoir. On peut transmettre ces modifications au repo distant dont nous sommes partis.

Pour voir les différences avec le repo distant `git diff origin/master`.

Pour envoyer nos modifications `git push`.

Le contenu du repo local est poussé sur le serveur. Le repo local et  la copie distante sont identiques  ?

--

`git diff master origin/master`
 

--

* Modifier le fichier `manchots.Rmd`, que va donner la commande  `git diff master origin/master`, pourquoi ?


---
template: gitintro

## Utiliser git : vision du processus

<img src="../resources/figs/Vision_globale_git_step2.png" width="800" height = "300" alt = "bilan1"></img>

--

### Analogie avec une photo (snapshot)

- Dans le répertoire de travail, on essaie des poses (Working directory)

- Quand est satisfait de la position d'un objet, on lui demande de rester ainsi (Staging area)

- Quand on est satisfait de la position de tous les objets, on prend la photo (local repos)

- On publie la photo pour que tout le monde en profite (remote repo)


---
template: gitintro

## Utiliser git : Travailler à plusieurs

Le repo distant a pu être mis à jour pendant qu'on travaillait sur la version locale. Dans ce cas il faut intégrer les modifications.

```{r git_pull, eval = FALSE }
git pull 
```

--

Si personne n'a modifié la même portion du fichier que vous, git va tranquillement intégrer les modifications des autres dans votres code.

--

Si la même portion du fichier a été modifiée sur le serveur, git panique,  c'est le 

--

.care[CONFLIT]


```{r git_conflit, eval = FALSE}
CONFLICT (content): Merge conflict in manchots.Rmd
Automatic merge failed; fix conflicts and then commit the result.
```

--
Il faut résoudre le conflit 

```{r git_conflit_resolve, eval = FALSE}

<<<<<<< HEAD
L'objectif de cette classe est de proposer des représentations graphiques de ces données en collaborant à l'aide de l'outil git. Il faut bien une raison d'utiliser git.
=======
L'objectif de cette classe est de proposer des représentations graphiques de ces données en collaborant à l'aide de l'outil git. C'est un prétexte pour utiliser git.
>>>>>>> conflit
```

On édite le fichier pour choisir la bonne version, puis `git add, commit push`.


** Prendre un moment pour développer à deux ou trois et gérer nos conflits **


---
template: gitintro

## Utiliser git : vision du processus

<img src="../resources/figs/Vision_globale_git_step3.png" width="800" height = "300" alt = "bilan1"></img>


---
template: gitintro

## Utiliser git : Arbre des commits dans un cadre de conflit

<img src="../resources/figs/git4.svg" width="800" height = "600" alt = "bilan1"></img>


---
template: gitintro

## Utiliser git : Arbre des commits dans un cadre de conflit

<img src="../resources/figs/git5.svg" width="800" height = "600" alt = "bilan1"></img>

---
template: gitintro

## Utiliser git : Arbre des commits dans un cadre de conflit

<img src="../resources/figs/git6.svg" width="800" height = "600" alt = "bilan1"></img>



---
template: gitintro

## Utiliser git : développer sans se géner pour limiter les conflits

Pour limiter les conflits, pour faire des tests sans géner les autres, il existe la notion de branche.







---

# Pour finir

## Des aides mémoires

[Git Cheat sheet](https://education.github.com/git-cheat-sheet-education.pdf)

## Références

```{r refs, echo=FALSE, results="asis", eval = TRUE, cache = FALSE}
PrintBibliography(myBib)
```

